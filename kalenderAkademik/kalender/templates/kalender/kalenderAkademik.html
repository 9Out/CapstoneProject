{% extends 'base.html' %}
{% load static %}
{% block title %}Kalender Akademik UMS{% endblock %}
{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
{% endblock %}
{% block content %}
<div id="customAlertBar" class="custom-alert-bar">
    <span id="customAlertMessage"></span>
    <button id="customAlertCloseBtn" class="custom-alert-close-btn">×</button>
</div>

<div class="kalender-container">
    <div class="kalender-main-container">
        <div class="kalender-calendar-container">
            <div id="calendar"></div>
        </div>
        <div class="kalender-agenda-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2>Agenda Akademik</h2>
                {% if user.is_authenticated %}
                {% if perms.kalender.add_kegiatan %}
                <button onclick="openModal()" class="kalender-btn-add">Tambah</button>
                {% endif %}
                {% endif %}
            </div>

            <div id="eventModal" class="kalender-page-modal">
                <div class="kalender-modal-content">
                    <span id="closeEventModalBtn" class="kalender-close-btn">×</span>
                    <h3>Tambah Kegiatan</h3>
                    <form id="eventForm">
                        <label for="eventTitle">Nama Kegiatan</label>
                        <input type="text" id="eventTitle" name="nama" placeholder="Nama Kegiatan" required />

                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 120px;">
                                <label for="eventStart">Tanggal Mulai</label>
                                <input type="date" id="eventStart" name="start" required />
                            </div>
                            <div style="flex: 1; min-width: 120px;">
                                <label for="eventEnd">Tanggal Selesai</label>
                                <input type="date" id="eventEnd" name="end" />
                            </div>
                        </div>

                        <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 0.5rem;">
                            <div style="flex: 1; min-width: 120px;">
                                <label for="eventDays">Jumlah Hari</label>
                                <input type="text" id="eventDays" readonly />
                            </div>
                            <div style="flex: 1; min-width: 120px;">
                                <label for="eventCategory">Kategori</label>
                                <select id="eventCategory" name="kategori_id" required>
                                    <option value="">Pilih Kategori</option>
                                </select>
                            </div>
                        </div>

                        <label for="eventDescription" style="margin-top: 0.5rem;">Deskripsi/Lokasi</label>
                        <input type="text" id="eventDescription" name="deskripsi" placeholder="Deskripsi atau Lokasi" />

                        <button type="submit" class="kalender-btn-submit">Tambah Kegiatan</button>
                    </form>
                </div>
            </div>

            <div id="editEventModal" class="kalender-page-modal">
                <div class="kalender-modal-content">
                    <span id="closeEditEventModalBtn" class="kalender-close-btn">×</span>
                    <h3>Edit Kegiatan</h3>
                    <form id="editEventForm">
                        <input type="hidden" id="editEventId" name="event_id">
                        <label for="editEventTitle">Nama Kegiatan</label>
                        <input type="text" id="editEventTitle" name="nama" placeholder="Nama Kegiatan" required />

                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 120px;">
                                <label for="editEventStart">Tanggal Mulai</label>
                                <input type="date" id="editEventStart" name="start" required />
                            </div>
                            <div style="flex: 1; min-width: 120px;">
                                <label for="editEventEnd">Tanggal Selesai</label>
                                <input type="date" id="editEventEnd" name="end" />
                            </div>
                        </div>

                        <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 0.5rem;">
                            <div style="flex: 1; min-width: 120px;">
                                <label for="editEventDays">Jumlah Hari</label>
                                <input type="text" id="editEventDays" readonly />
                            </div>
                            <div style="flex: 1; min-width: 120px;">
                                <label for="editEventCategory">Kategori</label>
                                <select id="editEventCategory" name="kategori_id" required>
                                    <option value="">Pilih Kategori</option>
                                </select>
                            </div>
                        </div>

                        <label for="editEventDescription" style="margin-top: 0.5rem;">Deskripsi/Lokasi</label>
                        <input type="text" id="editEventDescription" name="deskripsi"
                            placeholder="Deskripsi atau Lokasi" />

                        <button type="submit" class="kalender-btn-submit">Simpan Perubahan</button>
                    </form>
                </div>
            </div>

            <div id="deleteConfirmModal" class="kalender-page-modal">
                <div class="kalender-modal-content">
                    <span id="closeDeleteConfirmModalBtn" class="kalender-close-btn">×</span>
                    <h3>Konfirmasi Hapus</h3>
                    <p id="deleteConfirmMessage">Apakah Anda yakin ingin menghapus kegiatan ini?</p>
                    <input type="hidden" id="deleteEventId" name="event_id">
                    <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                        <button type="button" id="confirmDeleteBtn" class="kalender-btn-confirm">Ya</button>
                        <button type="button" id="cancelDeleteBtn" class="kalender-btn-cancel">Tidak</button>
                    </div>
                </div>
            </div>

            <div id="notificationModal" class="kalender-page-modal">
                <div class="kalender-modal-content">
                    <span id="closeNotificationModalBtn" class="kalender-close-btn">×</span>
                    <h3>Setel Notifikasi</h3>
                    <p>Kegiatan: <strong id="notificationEventTitle"></strong></p>
                    <form id="notificationForm">
                        <input type="hidden" id="notificationEventId" name="kegiatan_id_notif">
                        <div class="notification-options-group">
                            <label>Metode Notifikasi:</label>
                            <div class="notification-option">
                                <input type="radio" id="notifMethodEmail" name="notifMethod" value="email" checked>
                                <label for="notifMethodEmail">Email</label>
                            </div>
                            <div class="notification-option">
                                <input type="radio" id="notifMethodWhatsapp" name="notifMethod" value="whatsapp">
                                <label for="notifMethodWhatsapp">WhatsApp</label>
                            </div>
                        </div>
                        <button type="submit" class="kalender-btn-submit">Simpan Notifikasi</button>
                    </form>
                </div>
            </div>

            <input type="text" id="search" placeholder="Cari kegiatan..." />
            <script>
                // Event listener untuk input pencarian
                document.getElementById('search').addEventListener('input', function () {
                    filterAgenda(); // Memanggil fungsi filterAgenda setiap kali ada input
                });
            </script>
            <div id="agenda-container"></div>
        </div>
    </div>
</div>

<script>
    // Variabel Global dan Inisiasi Elemen DOM

    // Elemen DOM untuk Kalender dan Agenda
    /** Elemen untuk kalender dan daftar agenda */
    const calendarEl = document.getElementById('calendar');
    const agendaContainer = document.getElementById('agenda-container');

    // Elemen DOM untuk Alert Kustom
    /** Elemen untuk menampilkan dan mengontrol alert kustom */
    const customAlertBar = document.getElementById('customAlertBar');
    const customAlertMessage = document.getElementById('customAlertMessage');
    const customAlertCloseBtn = document.getElementById('customAlertCloseBtn');

    // Elemen DOM untuk Modal Tambah Kegiatan
    /** Elemen untuk modal dan form tambah kegiatan */
    const modal = document.getElementById('eventModal');
    const eventForm = document.getElementById('eventForm');
    const eventStart = document.getElementById('eventStart');
    const eventEnd = document.getElementById('eventEnd');
    const eventDays = document.getElementById('eventDays');
    const eventCategory = document.getElementById('eventCategory');
    const closeEventModalBtn = document.getElementById('closeEventModalBtn');

    // Elemen DOM untuk Modal Edit Kegiatan
    /** Elemen untuk modal dan form edit kegiatan */
    const editModal = document.getElementById('editEventModal');
    const editEventForm = document.getElementById('editEventForm');
    const editEventId = document.getElementById('editEventId');
    const editEventTitle = document.getElementById('editEventTitle');
    const editEventStart = document.getElementById('editEventStart');
    const editEventEnd = document.getElementById('editEventEnd');
    const editEventDays = document.getElementById('editEventDays');
    const editEventCategory = document.getElementById('editEventCategory');
    const editEventDescription = document.getElementById('editEventDescription');
    const closeEditEventModalBtn = document.getElementById('closeEditEventModalBtn');

    // Elemen DOM untuk Modal Konfirmasi Hapus
    /** Elemen untuk modal konfirmasi hapus kegiatan */
    const deleteConfirmModal = document.getElementById('deleteConfirmModal');
    const deleteConfirmMessage = document.getElementById('deleteConfirmMessage');
    const deleteEventId = document.getElementById('deleteEventId');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
    const closeDeleteConfirmModalBtn = document.getElementById('closeDeleteConfirmModalBtn');

    // Elemen DOM untuk Modal Notifikasi
    /** Elemen untuk modal dan form notifikasi */
    const notificationModal = document.getElementById('notificationModal');
    const closeNotificationModalBtn = document.getElementById('closeNotificationModalBtn');
    const notificationForm = document.getElementById('notificationForm');
    const notificationEventTitle = document.getElementById('notificationEventTitle');
    const notificationEventIdInput = document.getElementById('notificationEventId');

    // Variabel Konfigurasi
    /** Konfigurasi untuk ID pengguna, kategori, dan timeout alert */
    const KATEGORI_PENGUMUMAN_LOWERCASE = "pengumuman";
    let alertTimeout;

    // Fungsi

    /** Menampilkan pesan alert kustom di UI */
    function showCustomAlert(message, type = 'error', duration = 5000) {
        if (!customAlertBar || !customAlertMessage) {
            console.warn('Custom alert elements not found. Falling back to default alert.');
            alert(message);
            return;
        }
        if (alertTimeout) clearTimeout(alertTimeout);
        customAlertMessage.textContent = message;
        customAlertBar.className = 'custom-alert-bar';
        customAlertBar.classList.add(type, 'show');
        alertTimeout = setTimeout(hideCustomAlert, duration);
    }

    /** Menyembunyikan alert kustom */
    function hideCustomAlert() {
        if (customAlertBar) customAlertBar.classList.remove('show');
    }

    /** Memformat string tanggal ke format YYYY-MM-DD */
    function formatDateString(dateStr) {
        if (!dateStr) return null;
        const parts = dateStr.split('-');
        if (parts.length !== 3) return null;
        const year = parts[0];
        const month = parts[1].padStart(2, '0');
        const day = parts[2].padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    /** Menghitung jumlah hari untuk modal tambah kegiatan */
    function calculateDays() {
        const startVal = eventStart.value;
        const endVal = eventEnd.value;
        if (!startVal) {
            eventDays.value = '';
            return;
        }
        const startDate = new Date(startVal);
        if (!endVal) {
            eventDays.value = "1 hari";
            return;
        }
        const endDate = new Date(endVal);
        if (!isNaN(startDate) && !isNaN(endDate) && endDate >= startDate) {
            const diff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
            eventDays.value = diff + " hari";
        } else if (!isNaN(startDate) && (isNaN(endDate) || startDate.getTime() === endDate.getTime())) {
            eventDays.value = "1 hari";
        } else {
            eventDays.value = '';
        }
    }

    /** Menghitung jumlah hari untuk modal edit kegiatan */
    function calculateEditDays() {
        const startVal = editEventStart.value;
        const endVal = editEventEnd.value;
        if (!startVal) {
            editEventDays.value = '';
            return;
        }
        const startDate = new Date(startVal);
        if (!endVal) {
            editEventDays.value = "1 hari";
            return;
        }
        const endDate = new Date(endVal);
        if (!isNaN(startDate) && !isNaN(endDate) && endDate >= startDate) {
            const diff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
            editEventDays.value = diff + " hari";
        } else if (!isNaN(startDate) && (isNaN(endDate) || startDate.getTime() === endDate.getTime())) {
            editEventDays.value = "1 hari";
        } else {
            editEventDays.value = '';
        }
    }

    /** Memuat daftar kategori dari API ke elemen select */
    async function loadCategories(targetSelect) {
        try {
            const response = await fetch('/api/categories/');
            if (!response.ok) throw new Error('Gagal memuat kategori');
            const categories = await response.json();
            targetSelect.innerHTML = '<option value="">Pilih Kategori</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.nama;
                targetSelect.appendChild(option);
            });
        } catch (err) {
            console.error('Error memuat kategori:', err);
            showCustomAlert('Gagal memuat kategori. Silakan coba lagi.', 'error');
        }
    }

    /** Memuat data agenda untuk rentang tanggal aktif di kalender */
    async function loadAgenda(start, end) {
        try {
            const startDate = new Date(start);
            const endDate = new Date(end);
            const startStr = startDate.toISOString();
            const endStr = endDate.toISOString();
            const year = startDate.getFullYear();
            const [eventsResponse, holidaysResponse] = await Promise.all([
                fetch(`/api/events/?start=${startStr}&end=${endStr}`),
                fetch(`https://api-harilibur.vercel.app/api?year=${year}`)
            ]);
            const eventsData = await eventsResponse.json();
            const holidaysData = await holidaysResponse.json();
            const filteredEvents = eventsData.filter(event =>
                event.kategori && event.kategori.toLowerCase() !== KATEGORI_PENGUMUMAN_LOWERCASE
            );
            const filteredHolidays = holidaysData
                .filter(holiday => holiday.is_national_holiday)
                .map(holiday => ({
                    title: holiday.holiday_name,
                    start: formatDateString(holiday.holiday_date),
                    end: formatDateString(holiday.holiday_date),
                    backgroundColor: '#ff0000',
                    isHoliday: true,
                    id: `holiday-${formatDateString(holiday.holiday_date)}`,
                    deskripsi: 'Hari Libur Nasional'
                }))
                .filter(holiday => {
                    const holidayDate = new Date(holiday.start);
                    return holiday.start && !isNaN(holidayDate) && holidayDate >= startDate && holidayDate <= endDate;
                });
            const sortedAgenda = [...filteredEvents, ...filteredHolidays].sort((a, b) =>
                new Date(a.start) - new Date(b.start)
            );
            renderAgenda(sortedAgenda);
        } catch (err) {
            console.error('Error memuat agenda:', err);
            agendaContainer.innerHTML = '<p>Gagal memuat agenda.</p>';
            showCustomAlert('Gagal memuat data agenda.', 'error');
        }
    }

    /** Menampilkan daftar agenda ke dalam UI */
    function renderAgenda(agendaList) {
        const currentUserId = {{ user_id|default:'null' }};
        agendaContainer.innerHTML = '';
        const filteredAgendaList = agendaList.filter(agenda =>
            !agenda.kategori || agenda.kategori.toLowerCase() !== KATEGORI_PENGUMUMAN_LOWERCASE
        );
        if (filteredAgendaList.length === 0) {
            agendaContainer.innerHTML = '<p>Tidak ada agenda kegiatan yang sesuai dengan periode atau pencarian ini.</p>';
            return;
        }
        filteredAgendaList.forEach(agenda => {
            const startDate = new Date(agenda.start);
            let endDate = agenda.end && !agenda.isHoliday ? new Date(agenda.end) : null;
            const formatTanggal = (date) => date.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
            const formatTanggalTanpaTahun = (date) => date.toLocaleDateString('id-ID', { day: 'numeric', month: 'long' });
            let tanggalText = '';
            if (!endDate || startDate.getTime() >= new Date(endDate).getTime()) {
                tanggalText = formatTanggal(startDate);
            } else {
                const displayEndDate = new Date(endDate);
                displayEndDate.setDate(displayEndDate.getDate() - 1);
                if (startDate.toDateString() === displayEndDate.toDateString()) {
                    tanggalText = formatTanggal(startDate);
                } else if (displayEndDate < startDate) {
                    tanggalText = formatTanggal(startDate);
                } else {
                    const startTahun = startDate.getFullYear();
                    const endTahun = displayEndDate.getFullYear();
                    const startBulan = startDate.getMonth();
                    const endBulan = displayEndDate.getMonth();
                    if (startTahun !== endTahun) {
                        tanggalText = `${formatTanggal(startDate)} - ${formatTanggal(displayEndDate)}`;
                    } else if (startBulan !== endBulan) {
                        tanggalText = `${formatTanggalTanpaTahun(startDate)} - ${formatTanggal(displayEndDate)}`;
                    } else {
                        tanggalText = `${startDate.getDate()} - ${displayEndDate.getDate()} ${startDate.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' })}`;
                    }
                }
            }
            
            const agendaEl = document.createElement('div');
            agendaEl.className = 'kalender-agenda-item';
            agendaEl.style.borderLeftColor = agenda.backgroundColor || '#ff0000';
            let bellButtonHTML = '';
            let actionButtonsHTML = `
            <button class="kalender-action-btn gcal" title="Tambahkan ke Google Calendar" onclick="addToGoogleCalendar('${agenda.title.replace(/'/g, "\\'")}', '${agenda.start}', '${agenda.end || agenda.start}')">
                <img src="https://img.icons8.com/?size=100&id=WKF3bm1munsk&format=png&color=000000" alt="Google Calendar">
            </button>
        `;
            if ('{{ user.is_authenticated }}' === 'True' && !agenda.isHoliday) {
                bellButtonHTML = `
                <button class="kalender-btn-bell-icon" title="Setel Notifikasi" onclick="showNotificationPopup('${agenda.title.replace(/'/g, "\\'")}', '${agenda.start}', ${agenda.id})">
                    <i class="fa-regular fa-bell"></i>
                </button>`;
                if (currentUserId && agenda.user_fk === currentUserId) {
                    actionButtonsHTML += `
                    <button class="kalender-action-btn edit" title="Edit Kegiatan" onclick="openEditModal(${agenda.id}, '${agenda.title.replace(/'/g, "\\'")}', '${agenda.start}', '${agenda.end || ''}', ${agenda.kategori_id}, '${agenda.deskripsi ? agenda.deskripsi.replace(/'/g, "\\'") : ''}')">
                        <i class="fas fa-pencil-alt"></i>
                    </button>
                    <button class="kalender-action-btn delete" title="Hapus Kegiatan" onclick="openDeleteConfirmModal(${agenda.id}, '${agenda.title.replace(/'/g, "\\'")}')">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                `;
                }
            }
            agendaEl.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <div class="kalender-agenda-item-title">${agenda.title}</div>
                    <div class="kalender-agenda-date">Tanggal: ${tanggalText}</div>
                    ${agenda.deskripsi ? `<div class="kalender-agenda-location">Deskripsi: ${agenda.deskripsi}</div>` : ''}
                </div>
                ${bellButtonHTML}
            </div>
            <div class="kalender-agenda-actions">
                ${actionButtonsHTML}
            </div>
        `;
            agendaContainer.appendChild(agendaEl);
        });
    }

    /** Membuka modal untuk menambah kegiatan baru */
    window.openModal = function () {
        loadCategories(eventCategory);
        eventForm.reset();
        eventDays.value = '';
        modal.classList.add('show');
    }

    /** Menutup modal tambah kegiatan */
    function closeModal() {
        modal.classList.remove('show');
    }

    /** Membuka modal edit kegiatan dengan data yang diisi */
    window.openEditModal = function (id, title, start, end, kategoriId, deskripsi) {
        editEventId.value = id;
        editEventTitle.value = title || '';
        const startDate = new Date(start);
        if (!isNaN(startDate)) {
            editEventStart.value = startDate.toISOString().split('T')[0];
        } else {
            editEventStart.value = '';
        }
        if (end) {
            const exclusiveEndDate = new Date(end);
            const inclusiveEndDateForModal = new Date(exclusiveEndDate.valueOf());
            inclusiveEndDateForModal.setDate(exclusiveEndDate.getDate() - 1);
            if (!isNaN(inclusiveEndDateForModal)) {
                editEventEnd.value = inclusiveEndDateForModal.toISOString().split('T')[0];
            } else {
                editEventEnd.value = '';
            }
        } else {
            editEventEnd.value = editEventStart.value || '';
        }
        editEventDescription.value = deskripsi || '';
        calculateEditDays();
        loadCategories(editEventCategory).then(() => {
            editEventCategory.value = kategoriId || '';
        });
        editModal.classList.add('show');
    }

    /** Menutup modal edit kegiatan */
    function closeEditModal() {
        if (editModal) editModal.classList.remove('show');
    }

    /** Membuka modal konfirmasi hapus kegiatan */
    window.openDeleteConfirmModal = function (id, title) {
        deleteEventId.value = id;
        deleteConfirmMessage.textContent = `Apakah Anda yakin ingin menghapus kegiatan "${title}"?`;
        deleteConfirmModal.classList.add('show');
    }

    /** Menutup modal konfirmasi hapus */
    function closeDeleteConfirmModal() {
        deleteConfirmModal.classList.remove('show');
    }

    /** Membuka modal untuk mengatur notifikasi kegiatan */
    function openNotificationModal(title, kegiatanId) {
        notificationEventTitle.textContent = title;
        notificationEventIdInput.value = kegiatanId;
        document.getElementById('notifMethodEmail').checked = true;
        notificationModal.classList.add('show');
    }

    /** Menutup modal notifikasi */
    function closeNotificationModal() {
        notificationModal.classList.remove('show');
    }

    /** Menyimpan preferensi notifikasi ke API */
    async function saveNotification(kegiatanId, method) {
        try {
            const response = await fetch('/api/save-notification/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ kegiatan_id: kegiatanId, metode: method })
            });
            const result = await response.json();
            if (result.success) {
                showCustomAlert('Notifikasi berhasil disimpan!', 'success');
            } else {
                showCustomAlert('Gagal menyimpan notifikasi: ' + (result.error || 'Kesalahan tidak diketahui.'), 'error');
            }
        } catch (error) {
            console.error('Error saving notification:', error);
            showCustomAlert('Terjadi kesalahan koneksi saat menyimpan notifikasi.', 'error');
        }
    }

    /** Memfilter dan menampilkan agenda berdasarkan pencarian */
    window.filterAgenda = function () {
        const q = document.getElementById('search').value.toLowerCase();
        const calendarInstance = calendar;
        const viewStart = calendarInstance.view.activeStart.toISOString();
        const viewEnd = calendarInstance.view.activeEnd.toISOString();
        const year = calendarInstance.view.activeStart.getFullYear();
        let url = q ? `/api/events/?search=${encodeURIComponent(q)}` : `/api/events/?start=${viewStart}&end=${viewEnd}`;
        Promise.all([
            fetch(url),
            fetch(`https://api-harilibur.vercel.app/api?year=${year}`)
        ])
            .then(([eventsResponse, holidaysResponse]) => Promise.all([eventsResponse.json(), holidaysResponse.json()]))
            .then(([eventsData, holidaysData]) => {
                const processedHolidays = holidaysData
                    .filter(holiday => holiday.is_national_holiday)
                    .map(holiday => ({
                        title: holiday.holiday_name,
                        start: formatDateString(holiday.holiday_date),
                        end: formatDateString(holiday.holiday_date),
                        backgroundColor: '#ff0000',
                        isHoliday: true,
                        id: `holiday-${formatDateString(holiday.holiday_date)}`,
                        deskripsi: 'Hari Libur Nasional'
                    }))
                    .filter(holiday => holiday.start && !isNaN(new Date(holiday.start)));
                let agendaList = q ? [
                    ...eventsData,
                    ...processedHolidays.filter(holiday =>
                        holiday.title.toLowerCase().includes(q) ||
                        (holiday.deskripsi && holiday.deskripsi.toLowerCase().includes(q))
                    )
                ] : [
                    ...eventsData,
                    ...processedHolidays.filter(holiday => {
                        const holidayDate = new Date(holiday.start);
                        return holidayDate >= new Date(viewStart) && holidayDate <= new Date(viewEnd);
                    })
                ];
                const sortedAgenda = agendaList.sort((a, b) => new Date(a.start) - new Date(b.start));
                renderAgenda(sortedAgenda);
            })
            .catch(err => {
                console.error('Error filtering agenda:', err);
                showCustomAlert('Gagal memfilter agenda.', 'error');
            });
    }

    /** Membuka tab baru untuk menambah kegiatan ke Google Calendar */
    window.addToGoogleCalendar = function (title, start, end) {
        const startDate = new Date(start);
        let endDateForGCal = end && new Date(end) >= startDate ? new Date(end) : new Date(startDate);
        if (startDate.toDateString() === endDateForGCal.toDateString()) {
            endDateForGCal.setDate(endDateForGCal.getDate() + 1);
        } else {
            endDateForGCal.setDate(endDateForGCal.getDate() + 1);
        }
        const formatDateForGCal = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        };
        const datesParam = `${formatDateForGCal(startDate)}/${formatDateForGCal(endDateForGCal)}`;
        const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${datesParam}`;
        window.open(url, '_blank');
    }

    /** Menampilkan modal notifikasi untuk kegiatan */
    window.showNotificationPopup = function (title, startDateUnused, kegiatanId) {
        openNotificationModal(title, kegiatanId);
    }

    /** Instance global untuk FullCalendar */
    let calendar;

    // Inisialisasi saat DOM selesai dimuat
    document.addEventListener('DOMContentLoaded', function () {
        // Inisialisasi FullCalendar
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            initialDate: new Date(),
            locale: 'id',
            headerToolbar: { left: 'title', center: '', right: 'today prev,next' },
            buttonText: { today: 'Hari Ini' },
            /** Menampilkan informasi agenda saat diklik */
            eventClick: function (info) {
                const message = `Agenda: ${info.event.title} - Tanggal: ${info.event.start.toLocaleDateString('id-ID')}`;
                showCustomAlert(message, 'info', 7000);
            },
            height: 'auto',
            fixedWeekCount: false,
            /** Memuat agenda saat rentang tanggal berubah */
            datesSet: function (info) {
                if (!document.getElementById('search').value) {
                    loadAgenda(info.view.activeStart, info.view.activeEnd);
                }
            },
            /** Mengambil data event untuk kalender */
            events: function (fetchInfo, successCallback, failureCallback) {
                Promise.all([
                    fetch(`/api/events/?start=${fetchInfo.startStr}&end=${fetchInfo.endStr}`).then(res => res.json()),
                    fetch(`https://api-harilibur.vercel.app/api?year=${fetchInfo.start.getFullYear()}`).then(res => res.json())
                ])
                    .then(([eventsData, holidaysData]) => {
                        const filteredEvents = eventsData.filter(event =>
                            event.kategori && event.kategori.toLowerCase() !== KATEGORI_PENGUMUMAN_LOWERCASE
                        );
                        const holidayEvents = holidaysData
                            .filter(holiday => holiday.is_national_holiday)
                            .map(holiday => ({
                                title: holiday.holiday_name,
                                start: formatDateString(holiday.holiday_date),
                                end: formatDateString(holiday.holiday_date),
                                backgroundColor: '#ff0000',
                                borderColor: '#ff0000',
                                allDay: true,
                                isHoliday: true
                            }))
                            .filter(holiday => holiday.start);
                        successCallback([...filteredEvents, ...holidayEvents]);
                    })
                    .catch(err => {
                        console.error('Error loading events for FullCalendar:', err);
                        failureCallback(err);
                    });
            }
        });
        calendar.render();

        // Event listener untuk resize window
        window.addEventListener('resize', () => calendar.updateSize());

        // Event listener untuk alert kustom
        if (customAlertCloseBtn) customAlertCloseBtn.addEventListener('click', hideCustomAlert);

        // Event listener untuk modal tambah kegiatan
        if (closeEventModalBtn) closeEventModalBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
        eventStart.addEventListener('change', calculateDays);
        eventEnd.addEventListener('change', calculateDays);
        /** Menangani submit form tambah kegiatan */
        eventForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const nama = document.getElementById('eventTitle').value.trim();
            const start = document.getElementById('eventStart').value;
            let end = document.getElementById('eventEnd').value;
            const kategori_id = document.getElementById('eventCategory').value;
            const deskripsi = document.getElementById('eventDescription').value.trim();
            if (!nama || !start || !kategori_id) {
                showCustomAlert('Nama kegiatan, tanggal mulai, dan kategori wajib diisi.', 'error');
                return;
            }
            if (!end) end = start;
            const startDate = new Date(start + 'T00:00:00+07:00');
            const endDateForStorage = new Date(end + 'T23:59:58+07:00');
            const newEvent = { nama, start: startDate.toISOString(), end: endDateForStorage.toISOString(), kategori_id, deskripsi };
            try {
                const response = await fetch('/api/events/add/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                    body: JSON.stringify(newEvent)
                });
                if (response.ok) {
                    showCustomAlert('Kegiatan berhasil ditambahkan!', 'success');
                    calendar.refetchEvents();
                    filterAgenda();
                    closeModal();
                } else {
                    const errorData = await response.json();
                    showCustomAlert('Gagal menambahkan kegiatan: ' + (errorData.error || JSON.stringify(errorData)), 'error');
                }
            } catch (err) {
                console.error('Error saat submit event:', err);
                showCustomAlert('Terjadi kesalahan koneksi saat menambahkan kegiatan.', 'error');
            }
        });

        // Event listener untuk modal edit kegiatan
        if (closeEditEventModalBtn) closeEditEventModalBtn.addEventListener('click', closeEditModal);
        if (editModal) editModal.addEventListener('click', (e) => { if (e.target === editModal) closeEditModal(); });
        editEventStart.addEventListener('change', calculateEditDays);
        editEventEnd.addEventListener('change', calculateEditDays);
        /** Menangani submit form edit kegiatan */
        editEventForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = editEventId.value;
            const nama = editEventTitle.value.trim();
            const start = editEventStart.value;
            let end = editEventEnd.value;
            const kategori_id = editEventCategory.value;
            const deskripsi = editEventDescription.value.trim();
            if (!nama || !start || !kategori_id) {
                showCustomAlert('Nama kegiatan, tanggal mulai, dan kategori wajib diisi.', 'error');
                return;
            }
            if (!end) end = start;
            const startDate = new Date(start + 'T00:00:00+07:00');
            const endDateForStorage = new Date(end + 'T23:59:58+07:00');
            const updatedEvent = { nama, start: startDate.toISOString(), end: endDateForStorage.toISOString(), kategori_id, deskripsi };
            try {
                const response = await fetch(`/api/events/update/${id}/`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                    body: JSON.stringify(updatedEvent)
                });
                if (response.ok) {
                    showCustomAlert('Kegiatan berhasil diperbarui!', 'success');
                    calendar.refetchEvents();
                    filterAgenda();
                    closeEditModal();
                } else {
                    const errorData = await response.json();
                    showCustomAlert('Gagal memperbarui kegiatan: ' + (errorData.error || JSON.stringify(errorData)), 'error');
                }
            } catch (err) {
                console.error('Error saat update event:', err);
                showCustomAlert('Terjadi kesalahan koneksi saat memperbarui kegiatan.', 'error');
            }
        });

        // Event listener untuk modal konfirmasi hapus
        if (closeDeleteConfirmModalBtn) closeDeleteConfirmModalBtn.addEventListener('click', closeDeleteConfirmModal);
        if (cancelDeleteBtn) cancelDeleteBtn.addEventListener('click', closeDeleteConfirmModal);
        if (deleteConfirmModal) deleteConfirmModal.addEventListener('click', (e) => { if (e.target === deleteConfirmModal) closeDeleteConfirmModal(); });
        /** Menangani konfirmasi penghapusan kegiatan */
        if (confirmDeleteBtn) confirmDeleteBtn.addEventListener('click', async () => {
            const id = deleteEventId.value;
            try {
                const response = await fetch(`/api/events/delete/${id}/`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' }
                });
                if (response.ok) {
                    showCustomAlert('Kegiatan berhasil dihapus!', 'success');
                    calendar.refetchEvents();
                    filterAgenda();
                    closeDeleteConfirmModal();
                } else {
                    const errorData = await response.json();
                    showCustomAlert('Gagal menghapus kegiatan: ' + (errorData.error || JSON.stringify(errorData)), 'error');
                }
            } catch (err) {
                console.error('Error saat delete event:', err);
                showCustomAlert('Terjadi kesalahan koneksi saat menghapus kegiatan.', 'error');
            }
        });

        // Event listener untuk modal notifikasi
        if (closeNotificationModalBtn) closeNotificationModalBtn.addEventListener('click', closeNotificationModal);
        if (notificationModal) notificationModal.addEventListener('click', (e) => { if (e.target === notificationModal) closeNotificationModal(); });
        /** Menangani submit form notifikasi */
        if (notificationForm) notificationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const kegiatanId = notificationEventIdInput.value;
            const selectedMethodRadio = document.querySelector('input[name="notifMethod"]:checked');
            if (!selectedMethodRadio) {
                showCustomAlert('Silakan pilih metode notifikasi.', 'error');
                return;
            }
            const selectedMethod = selectedMethodRadio.value;
            if (kegiatanId && selectedMethod) {
                await saveNotification(kegiatanId, selectedMethod);
                closeNotificationModal();
            } else {
                showCustomAlert('Terjadi kesalahan, ID kegiatan atau metode tidak ditemukan.', 'error');
            }
        });

        // Memuat agenda awal
        filterAgenda();
    });


</script>
{% endblock %}